<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>The Neural Night — WebAR</title>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui}
    #intro{
      position:fixed;inset:0;z-index:10;display:flex;flex-direction:column;
      align-items:center;justify-content:center;gap:12px;text-align:center;
      background:radial-gradient(ellipse at center,#0d1520,#040608);color:#fff;padding:18px
    }
    #intro h1{margin:0;font-size:28px;letter-spacing:.08em;text-transform:uppercase}
    #intro p{margin:0;opacity:.85;max-width:560px;line-height:1.5}
    #startBtn{padding:14px 18px;border:none;border-radius:12px;background:#2b8cff;color:#fff;font-size:16px}
    #log{margin-top:10px;font-size:12px;opacity:.85;white-space:pre-wrap;text-align:left;max-width:720px}
  </style>

  <!-- ES MODULE IMPORTS (MindAR v1.2+ way) -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
      "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
    }
  }
  </script>
</head>

<body>
  <div id="intro">
    <h1>The Neural Night</h1>
    <p>Point camera at the poster. Tap to fire a neuron and watch signals travel.</p>
    <button id="startBtn">Start WebAR</button>
    <div id="log"></div>
  </div>

  <script type="module">
    import * as THREE from "three";
    import { MindARThree } from "mindar-image-three";

    const logEl = document.getElementById("log");
    const log = (m) => { console.log(m); logEl.textContent += m + "\n"; };

    // --- Neural overlay simulation (draw to canvas texture) ---
    function makeNeuralSim() {
      const neurons = [];
      const signals = [];
      const stars = [];
      const N = 90;

      for (let i=0;i<N;i++){
        neurons.push({
          x: Math.random(), y: Math.random(),
          r: 0.006 + Math.random()*0.015,
          fire: 0,
          type: Math.random()<0.13 ? "attn" : (Math.random()<0.16 ? "inhib" : "excit"),
          connections: []
        });
      }
      for (const n of neurons){
        for (const m of neurons){
          if (n===m) continue;
          const d = Math.hypot(n.x-m.x, n.y-m.y);
          if (d<0.18 && Math.random()<0.22) n.connections.push(m);
        }
      }

      const colorFor = (t) => t==="attn" ? "#c870e8" : (t==="inhib" ? "#7dcf7d" : "#5a90e0");

      function fireAt(u,v){
        let best=null, bd=1e9;
        for (const n of neurons){
          const d = Math.hypot(n.x-u, n.y-v);
          if (d<bd){ bd=d; best=n; }
        }
        if (!best || bd>0.12) return;

        best.fire = 90;
        const outs = best.connections.slice(0,5);
        for (const to of outs) signals.push({from:best, to, p:0, speed:0.035});

        for (let i=0;i<14;i++){
          const a=Math.random()*Math.PI*2;
          stars.push({x:best.x,y:best.y,vx:Math.cos(a)*0.006,vy:Math.sin(a)*0.006,life:1,decay:0.02});
        }
      }

      function stepAndDraw(ctx,w,h){
        ctx.clearRect(0,0,w,h);

        // connections
        ctx.save();
        ctx.globalAlpha=0.25;
        ctx.lineWidth=Math.max(1,Math.round(w*0.0012));
        ctx.strokeStyle="#5a90e0";
        for (const n of neurons){
          for (const m of n.connections){
            const x1=n.x*w,y1=n.y*h,x2=m.x*w,y2=m.y*h;
            const dx=x2-x1, dy=y2-y1;
            ctx.beginPath();
            ctx.moveTo(x1,y1);
            ctx.bezierCurveTo(
              x1+dx*0.35+(Math.random()-0.5)*12, y1+dy*0.35+(Math.random()-0.5)*12,
              x1+dx*0.65+(Math.random()-0.5)*12, y1+dy*0.65+(Math.random()-0.5)*12,
              x2,y2
            );
            ctx.stroke();
          }
        }
        ctx.restore();

        // neurons
        for (const n of neurons){
          const x=n.x*w,y=n.y*h;
          const firing=n.fire>0;
          const pulse=firing?(Math.sin(n.fire*0.35)*0.6+0.4):0;
          const rr=(n.r*(1+pulse*2.3))*w;

          const base = firing ? "#ffd966" : colorFor(n.type);
          const glow = firing ? "#fffacc" : base;

          for (let ring=4; ring>=1; ring--){
            const r2=rr*(1+ring*0.9);
            const g=ctx.createRadialGradient(x,y,0,x,y,r2);
            g.addColorStop(0, glow+(firing?"AA":"66"));
            g.addColorStop(1,"transparent");
            ctx.globalAlpha=0.65;
            ctx.fillStyle=g;
            ctx.beginPath(); ctx.arc(x,y,r2,0,Math.PI*2); ctx.fill();
          }
          ctx.globalAlpha=1;

          for (let i=0;i<5;i++){
            ctx.globalAlpha=0.7+Math.random()*0.25;
            ctx.fillStyle=base;
            ctx.beginPath();
            ctx.arc(x+(Math.random()-0.5)*rr*0.6, y+(Math.random()-0.5)*rr*0.6, rr*(0.45+Math.random()*0.55), 0, Math.PI*2);
            ctx.fill();
          }
          ctx.globalAlpha=1;

          if (n.fire>0) n.fire--;
        }

        // signals
        for (let i=signals.length-1;i>=0;i--){
          const s=signals[i];
          s.p+=s.speed;
          const x=(s.from.x+(s.to.x-s.from.x)*s.p)*w;
          const y=(s.from.y+(s.to.y-s.from.y)*s.p)*h;

          const g=ctx.createRadialGradient(x,y,0,x,y,w*0.02);
          g.addColorStop(0,"#ffffff");
          g.addColorStop(0.35,"#ffd966");
          g.addColorStop(1,"transparent");
          ctx.globalAlpha=0.95;
          ctx.fillStyle=g;
          ctx.beginPath(); ctx.arc(x,y,w*0.02,0,Math.PI*2); ctx.fill();
          ctx.globalAlpha=1;

          if (s.p>=1){
            s.to.fire=Math.max(s.to.fire,65);
            signals.splice(i,1);
          }
        }

        // stars
        for (let i=stars.length-1;i>=0;i--){
          const p=stars[i];
          p.x+=p.vx; p.y+=p.vy; p.life-=p.decay;
          if (p.life<=0){ stars.splice(i,1); continue; }
          ctx.globalAlpha=Math.max(0,p.life);
          ctx.fillStyle="#fffacc";
          ctx.beginPath(); ctx.arc(p.x*w,p.y*h,2+p.life*4,0,Math.PI*2); ctx.fill();
          ctx.globalAlpha=1;
        }
      }

      return { fireAt, stepAndDraw };
    }

    async function startWebAR(){
      try{
        log("Creating MindARThree...");
        const mindarThree = new MindARThree({
          container: document.body,
          imageTargetSrc: "assets/targets.mind",
          uiLoading: "no",
          uiScanning: "yes",
          maxTrack: 1
        });

        const { renderer, scene, camera } = mindarThree;
        scene.add(new THREE.AmbientLight(0xffffff, 1));

        const anchor = mindarThree.addAnchor(0);

        const POSTER_W=1.0, POSTER_H=1.33;

        const texCanvas=document.createElement("canvas");
        texCanvas.width=768;
        texCanvas.height=Math.round(768*(POSTER_H/POSTER_W));
        const texCtx=texCanvas.getContext("2d");

        const overlayTex=new THREE.CanvasTexture(texCanvas);
        overlayTex.minFilter=THREE.LinearFilter;
        overlayTex.magFilter=THREE.LinearFilter;

        const overlayPlane=new THREE.Mesh(
          new THREE.PlaneGeometry(POSTER_W,POSTER_H),
          new THREE.MeshBasicMaterial({ map: overlayTex, transparent:true, opacity:0.95 })
        );
        overlayPlane.position.set(0,0,0.01);
        anchor.group.add(overlayPlane);

        const sim = makeNeuralSim();

        // Tap -> raycast -> uv -> fire
        const raycaster=new THREE.Raycaster();
        const pointer=new THREE.Vector2();

        function onTap(e){
          const rect=renderer.domElement.getBoundingClientRect();
          const cx=(e.touches?e.touches[0].clientX:e.clientX);
          const cy=(e.touches?e.touches[0].clientY:e.clientY);
          pointer.x=((cx-rect.left)/rect.width)*2-1;
          pointer.y=-(((cy-rect.top)/rect.height)*2-1);

          raycaster.setFromCamera(pointer,camera);
          const hits=raycaster.intersectObject(overlayPlane,true);
          if(!hits.length || !hits[0].uv) return;

          const u=hits[0].uv.x;
          const v=1-hits[0].uv.y; // flip
          sim.fireAt(u,v);
        }
        window.addEventListener("pointerdown", onTap, {passive:true});
        window.addEventListener("touchstart", onTap, {passive:true});

        log("Starting camera...");
        await mindarThree.start();
        document.getElementById("intro").style.display="none";
        log("✅ Started. Point at poster and tap.");

        renderer.setAnimationLoop(()=>{
          sim.stepAndDraw(texCtx, texCanvas.width, texCanvas.height);
          overlayTex.needsUpdate=true;
          renderer.render(scene,camera);
        });

      } catch(e){
        log("❌ "+String(e?.stack||e));
        alert(String(e));
      }
    }

    document.getElementById("startBtn").addEventListener("click", startWebAR);
  </script>
</body>
</html>
