<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Neural Night - Interactive AI</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background: #0a0e1a;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* ========== WELCOME SCREEN ========== */
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0e27, #1a1f3a);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
            transition: opacity 0.5s ease;
        }

        #welcome-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .logo {
            font-size: 64px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .title {
            font-size: clamp(28px, 6vw, 40px);
            font-weight: 800;
            background: linear-gradient(135deg, #FFD700, #FFA500, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .subtitle {
            font-size: clamp(14px, 3vw, 18px);
            color: rgba(255, 215, 0, 0.8);
            margin-bottom: 40px;
            text-align: center;
        }

        .instructions {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 16px;
            padding: 20px;
            max-width: 90%;
            width: 400px;
            margin-bottom: 30px;
        }

        .instruction-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 15px;
            text-align: left;
        }

        .instruction-item:last-child {
            margin-bottom: 0;
        }

        .step-num {
            min-width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .step-text {
            color: white;
            font-size: 14px;
            line-height: 1.5;
            padding-top: 4px;
        }

        .start-btn {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            color: #000;
            padding: 16px 48px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(255, 215, 0, 0.4);
            transition: transform 0.3s ease;
        }

        .start-btn:active {
            transform: scale(0.98);
        }

        /* ========== AR INTERFACE ========== */
        #ar-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        #ar-interface.active {
            display: block;
        }

        /* Exit Button */
        #exit-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 44px;
            height: 44px;
            background: rgba(239, 68, 68, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            cursor: pointer;
            z-index: 10001;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
        }

        #exit-btn:active {
            transform: scale(0.9);
        }

        /* Instructions Overlay */
        #instructions-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: opacity 0.3s ease;
        }

        #instructions-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .instructions-card {
            background: rgba(15, 15, 30, 0.95);
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            width: 400px;
            text-align: center;
        }

        .instructions-title {
            font-size: 20px;
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 20px;
        }

        .instructions-list {
            text-align: left;
            margin-bottom: 20px;
        }

        .scanning-animation {
            width: 120px;
            height: 120px;
            margin: 20px auto;
            position: relative;
        }

        .scan-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid #FFD700;
            border-radius: 50%;
            animation: scanPulse 2s ease-in-out infinite;
        }

        @keyframes scanPulse {
            0%, 100% { transform: scale(0.8); opacity: 0.5; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
            50% { transform: scale(1); opacity: 1; box-shadow: 0 0 40px rgba(255, 215, 0, 0.6); }
        }

        .scan-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
        }

        /* Text Input */
        #text-input-panel {
            position: fixed;
            top: 15px;
            left: 15px;
            right: 70px;
            background: rgba(10, 10, 20, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 12px;
            padding: 12px;
            display: none;
            pointer-events: auto;
        }

        .input-wrapper {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        #text-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            color: white;
            font-size: 14px;
            outline: none;
        }

        #text-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        #send-btn {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            color: #000;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        #send-btn:active {
            transform: scale(0.95);
        }

        .quick-chips {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .chip {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 4px 10px;
            font-size: 11px;
            color: #FFD700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chip:active {
            background: rgba(255, 215, 0, 0.3);
            transform: scale(0.95);
        }

        /* Layer Info */
        #layer-info {
            position: fixed;
            bottom: 15px;
            left: 15px;
            right: 15px;
            background: rgba(10, 10, 20, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 12px;
            padding: 12px;
            display: none;
        }

        .layer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .layer-name {
            font-size: 12px;
            font-weight: 700;
            color: #FFD700;
            text-transform: uppercase;
        }

        .layer-status {
            font-size: 11px;
            color: #FFA500;
            font-weight: 600;
        }

        .layer-desc {
            font-size: 13px;
            color: white;
            line-height: 1.4;
        }

        /* Responsive adjustments */
        @media (orientation: landscape) {
            #text-input-panel {
                max-width: 400px;
            }

            #layer-info {
                max-width: 400px;
                left: auto;
                right: 15px;
            }
        }

        @media (max-width: 400px) {
            .title {
                font-size: 32px;
            }

            .instructions {
                padding: 15px;
            }

            .step-text {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcome-screen">
        <div class="logo">‚ú®</div>
        <div class="title">Neural Night</div>
        <div class="subtitle">Watch Golden Sparks of AI Thinking</div>
        
        <div class="instructions">
            <div class="instruction-item">
                <div class="step-num">1</div>
                <div class="step-text">Point your camera at the Neural Night poster</div>
            </div>
            <div class="instruction-item">
                <div class="step-num">2</div>
                <div class="step-text">Type any text and watch golden sparks flow</div>
            </div>
            <div class="instruction-item">
                <div class="step-num">3</div>
                <div class="step-text">Tap neurons to create electric sparkles</div>
            </div>
            <div class="instruction-item">
                <div class="step-num">4</div>
                <div class="step-text">See words travel with golden particle trails</div>
            </div>
        </div>

        <button class="start-btn" id="start-btn">Launch Experience</button>
    </div>

    <!-- AR Interface -->
    <div id="ar-interface">
        <!-- Exit Button -->
        <div id="exit-btn">
            <span style="font-size: 20px; color: white; font-weight: bold;">‚úï</span>
        </div>

        <!-- Instructions Overlay -->
        <div id="instructions-overlay">
            <div class="instructions-card">
                <div class="instructions-title">üéØ Find the Poster</div>
                
                <div class="scanning-animation">
                    <div class="scan-ring"></div>
                    <div class="scan-icon">üì±</div>
                </div>
                
                <div class="instructions-list">
                    <div class="instruction-item">
                        <div class="step-num">1</div>
                        <div class="step-text">Hold phone steady and point at Neural Night poster</div>
                    </div>
                    <div class="instruction-item">
                        <div class="step-num">2</div>
                        <div class="step-text">Make sure poster is well-lit and fully visible</div>
                    </div>
                    <div class="instruction-item">
                        <div class="step-num">3</div>
                        <div class="step-text">Keep camera about 1-2 feet away</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Text Input Panel -->
        <div id="text-input-panel">
            <div class="input-wrapper">
                <input type="text" id="text-input" placeholder="Type your thought..." maxlength="50">
                <button id="send-btn">Send</button>
            </div>
            <div class="quick-chips">
                <div class="chip" data-text="Starry night sky">‚≠ê Starry night</div>
                <div class="chip" data-text="Dream of colors">üé® Dream colors</div>
                <div class="chip" data-text="Paint universe">üåå Paint universe</div>
                <div class="chip" data-text="Golden thoughts">‚ú® Golden thoughts</div>
            </div>
        </div>

        <!-- Layer Info -->
        <div id="layer-info">
            <div class="layer-header">
                <div class="layer-name" id="current-layer">Embedding Layer</div>
                <div class="layer-status" id="layer-status">Ready</div>
            </div>
            <div class="layer-desc" id="layer-desc">Converts words into numerical vectors</div>
        </div>
    </div>

    <!-- A-Frame Scene -->
    <a-scene
        mindar-image="imageTargetSrc: ./assets/targets.mind; autoStart: false; uiLoading: no; uiError: no; uiScanning: no;"
        embedded
        renderer="colorManagement: true; antialias: true; alpha: true; precision: medium;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false">

        <a-assets>
            <audio id="ambient-audio" src="./audio/neural-ambience.mp3" preload="auto" loop></audio>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity id="target" mindar-image-target="targetIndex: 0">
            <a-entity id="network-container" position="0 0 0"></a-entity>
        </a-entity>
    </a-scene>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        const CONFIG = {
            layers: [
                { name: "Embedding", neurons: 6, x: -1.5, color: "#FFD700", desc: "Converts words into numerical vectors" },
                { name: "Attention-1", neurons: 10, x: -0.9, color: "#FFA500", desc: "Finds relationships between words" },
                { name: "Feed-Forward", neurons: 12, x: -0.3, color: "#FFBF00", desc: "Deep pattern transformation" },
                { name: "Normalization", neurons: 8, x: 0.3, color: "#FFD700", desc: "Stabilizes neural signals" },
                { name: "Attention-2", neurons: 10, x: 0.9, color: "#FFA500", desc: "Refines word understanding" },
                { name: "Output", neurons: 6, x: 1.5, color: "#FFCC00", desc: "Generates final result" }
            ],
            neuronRadius: 0.08,
            glowRadius: 0.15,
            connectionOpacity: 0.2,
            signalSpeed: 1200
        };

        const state = {
            arActive: false,
            targetFound: false,
            processing: false,
            neurons: [],
            connections: [],
            sceneReady: false,
            activeSignals: []
        };

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('start-btn').addEventListener('click', handleStart);
            document.getElementById('start-btn').addEventListener('touchend', (e) => {
                e.preventDefault();
                handleStart();
            });

            const exitBtn = document.getElementById('exit-btn');
            exitBtn.addEventListener('click', handleExit);
            exitBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                handleExit();
            });

            document.getElementById('send-btn').addEventListener('click', processInput);
            document.getElementById('text-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') processInput();
            });

            document.querySelectorAll('.chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.getElementById('text-input').value = chip.dataset.text;
                    processInput();
                });
            });

            const target = document.querySelector('#target');
            target.addEventListener('targetFound', onTargetFound);
            target.addEventListener('targetLost', onTargetLost);

            const scene = document.querySelector('a-scene');
            scene.addEventListener('loaded', () => {
                state.sceneReady = true;
            });
        }

        function handleStart() {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('ar-interface').classList.add('active');
            
            const scene = document.querySelector('a-scene');
            if (state.sceneReady) {
                startAR();
            } else {
                scene.addEventListener('loaded', startAR, { once: true });
            }
        }

        function startAR() {
            const arSystem = document.querySelector('a-scene').systems['mindar-image-system'];
            if (arSystem && !state.arActive) {
                arSystem.start().then(() => {
                    console.log('‚úÖ AR started');
                    state.arActive = true;
                }).catch((error) => {
                    console.error('‚ùå AR error:', error);
                    alert('Camera permission required. Please allow camera access.');
                    handleExit();
                });
            }
        }

        function handleExit() {
            if (state.arActive) {
                const arSystem = document.querySelector('a-scene').systems['mindar-image-system'];
                if (arSystem) arSystem.stop();
                state.arActive = false;
            }
            
            // Clean up active signals
            state.activeSignals.forEach(signal => {
                if (signal.element && signal.element.parentNode) {
                    signal.element.parentNode.removeChild(signal.element);
                }
            });
            state.activeSignals = [];
            
            document.getElementById('ar-interface').classList.remove('active');
            document.getElementById('welcome-screen').classList.remove('hidden');
            
            state.targetFound = false;
            state.processing = false;
        }

        // ============================================
        // TARGET DETECTION
        // ============================================

        function onTargetFound() {
            console.log('üéØ Target found!');
            state.targetFound = true;
            
            document.getElementById('instructions-overlay').classList.add('hidden');
            document.getElementById('text-input-panel').style.display = 'block';
            document.getElementById('layer-info').style.display = 'block';
            
            createNetwork();
            
            setTimeout(() => {
                document.getElementById('text-input').value = 'Golden thoughts';
                processInput();
            }, 1000);
            
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
        }

        function onTargetLost() {
            console.log('üëã Target lost');
            state.targetFound = false;
            
            document.getElementById('instructions-overlay').classList.remove('hidden');
            document.getElementById('text-input-panel').style.display = 'none';
            document.getElementById('layer-info').style.display = 'none';
            
            // Clean up signals
            state.activeSignals.forEach(signal => {
                if (signal.element && signal.element.parentNode) {
                    signal.element.parentNode.removeChild(signal.element);
                }
            });
            state.activeSignals = [];
        }

        // ============================================
        // NETWORK CREATION
        // ============================================

        function createNetwork() {
            const container = document.getElementById('network-container');
            container.innerHTML = '';
            state.neurons = [];
            state.connections = [];

            const aspect = window.innerWidth / window.innerHeight;
            const scale = aspect > 1 ? 1 : 0.8;
            container.setAttribute('scale', `${scale} ${scale} ${scale}`);

            CONFIG.layers.forEach((layerConfig, layerIdx) => {
                const layerNeurons = [];
                const spacing = 0.25;
                const totalHeight = (layerConfig.neurons - 1) * spacing;
                
                for (let i = 0; i < layerConfig.neurons; i++) {
                    const x = layerConfig.x;
                    const y = (i * spacing) - (totalHeight / 2);
                    const z = 0;
                    
                    const neuron = createNeuron(x, y, z, layerConfig.color, layerIdx, i);
                    container.appendChild(neuron);
                    
                    layerNeurons.push({
                        element: neuron,
                        position: { x, y, z },
                        color: layerConfig.color,
                        layer: layerIdx,
                        index: i
                    });
                }
                
                state.neurons.push(layerNeurons);
            });

            for (let l = 0; l < state.neurons.length - 1; l++) {
                const currentLayer = state.neurons[l];
                const nextLayer = state.neurons[l + 1];
                
                currentLayer.forEach((start) => {
                    nextLayer.forEach((end) => {
                        if (Math.random() < 0.4) {
                            const conn = createConnection(start.position, end.position);
                            container.appendChild(conn);
                            state.connections.push({ element: conn, start, end });
                        }
                    });
                });
            }

            window.addEventListener('resize', () => {
                const aspect = window.innerWidth / window.innerHeight;
                const scale = aspect > 1 ? 1 : 0.8;
                container.setAttribute('scale', `${scale} ${scale} ${scale}`);
            });
        }

        function createNeuron(x, y, z, color, layer, index) {
            const neuron = document.createElement('a-entity');
            neuron.setAttribute('position', `${x} ${y} ${z}`);
            neuron.setAttribute('data-layer', layer);
            neuron.setAttribute('data-index', index);

            const sphere = document.createElement('a-sphere');
            sphere.setAttribute('radius', CONFIG.neuronRadius);
            sphere.setAttribute('material', `
                shader: standard;
                color: ${color};
                metalness: 0.6;
                roughness: 0.2;
                emissive: ${color};
                emissiveIntensity: 1.0;
            `);

            const glow = document.createElement('a-sphere');
            glow.setAttribute('radius', CONFIG.glowRadius);
            glow.setAttribute('material', `
                shader: flat;
                color: ${color};
                transparent: true;
                opacity: 0.3;
            `);

            // Golden sparkles
            for (let i = 0; i < 6; i++) {
                const angle = (i / 6) * Math.PI * 2;
                const dist = CONFIG.neuronRadius * 1.9;
                const sparkle = document.createElement('a-sphere');
                sparkle.setAttribute('radius', '0.018');
                sparkle.setAttribute('position', `${Math.cos(angle) * dist} ${Math.sin(angle) * dist} 0`);
                sparkle.setAttribute('material', `
                    shader: flat;
                    color: #FFFF00;
                    emissive: #FFFF00;
                    emissiveIntensity: 3;
                `);
                sphere.appendChild(sparkle);
            }

            sphere.appendChild(glow);
            neuron.appendChild(sphere);

            neuron.addEventListener('click', () => {
                if (state.targetFound) {
                    activateNeuron(neuron, color);
                    createSparkBurst(neuron.object3D.position, color);
                }
            });

            return neuron;
        }

        function createConnection(start, end) {
            const dx = end.x - start.x;
            const dy = end.y - start.y;
            const dz = end.z - start.z;
            const distance = Math.sqrt(dx*dx + dy*dy + dz*dz);
            
            const midX = (start.x + end.x) / 2;
            const midY = (start.y + end.y) / 2;
            const midZ = (start.z + end.z) / 2;
            
            const line = document.createElement('a-cylinder');
            line.setAttribute('radius', '0.006');
            line.setAttribute('height', distance);
            line.setAttribute('material', `
                shader: flat;
                color: #FFD700;
                transparent: true;
                opacity: ${CONFIG.connectionOpacity};
            `);
            line.setAttribute('position', `${midX} ${midY} ${midZ}`);
            
            const rotY = Math.atan2(dx, dz) * 180 / Math.PI;
            const rotX = Math.atan2(Math.sqrt(dx*dx + dz*dz), dy) * 180 / Math.PI - 90;
            line.setAttribute('rotation', `${rotX} ${rotY} 0`);
            
            return line;
        }

        // ============================================
        // PROCESSING & ANIMATION
        // ============================================

        function processInput() {
            const text = document.getElementById('text-input').value.trim();
            if (!text || !state.targetFound || state.processing) return;
            
            state.processing = true;
            
            const words = text.split(/\s+/).filter(w => w.length > 0);
            
            let delay = 0;
            CONFIG.layers.forEach((layer, idx) => {
                setTimeout(() => {
                    updateLayerInfo(idx);
                    animateLayer(idx, words);
                    
                    if (idx < CONFIG.layers.length - 1) {
                        setTimeout(() => {
                            propagateWords(idx, words);
                        }, 600);
                    }
                }, delay);
                
                delay += 1500;
            });
            
            setTimeout(() => {
                state.processing = false;
            }, delay + 500);
        }

        function updateLayerInfo(layerIdx) {
            const layer = CONFIG.layers[layerIdx];
            document.getElementById('current-layer').textContent = layer.name;
            document.getElementById('layer-status').textContent = '‚ö° Active';
            document.getElementById('layer-desc').textContent = layer.desc;
            
            setTimeout(() => {
                document.getElementById('layer-status').textContent = '‚úì Ready';
            }, 1400);
        }

        function animateLayer(layerIdx, words) {
            const neurons = state.neurons[layerIdx];
            
            neurons.forEach((neuron, idx) => {
                setTimeout(() => {
                    activateNeuron(neuron.element, neuron.color);
                }, idx * 80);
            });
        }

        function activateNeuron(neuronElement, color) {
            const sphere = neuronElement.querySelector('a-sphere');
            const glow = sphere.querySelector('a-sphere');
            
            anime({
                targets: neuronElement.object3D.scale,
                x: [1, 1.6, 1],
                y: [1, 1.6, 1],
                z: [1, 1.6, 1],
                duration: 500,
                easing: 'easeOutElastic(1, 0.5)'
            });
            
            sphere.setAttribute('material', `emissive: ${color}; emissiveIntensity: 4.0`);
            glow.setAttribute('material', `opacity: 0.7`);
            
            setTimeout(() => {
                sphere.setAttribute('material', `emissive: ${color}; emissiveIntensity: 1.0`);
                glow.setAttribute('material', `opacity: 0.3`);
            }, 300);
            
            anime({
                targets: glow.object3D.scale,
                x: [1, 2.2, 1],
                y: [1, 2.2, 1],
                z: [1, 2.2, 1],
                duration: 500,
                easing: 'easeOutQuad'
            });
        }

        function createSparkBurst(position, color) {
            const container = document.getElementById('network-container');
            
            for (let i = 0; i < 12; i++) {
                const angle = (i / 12) * Math.PI * 2;
                const spark = document.createElement('a-sphere');
                spark.setAttribute('radius', '0.02');
                spark.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
                spark.setAttribute('material', `
                    shader: flat;
                    color: #FFFF00;
                    emissive: #FFFF00;
                    emissiveIntensity: 3;
                `);
                
                container.appendChild(spark);
                
                const distance = 0.4;
                const targetX = position.x + Math.cos(angle) * distance;
                const targetY = position.y + Math.sin(angle) * distance;
                const targetZ = position.z + (Math.random() - 0.5) * 0.2;
                
                anime({
                    targets: spark.object3D.position,
                    x: targetX,
                    y: targetY,
                    z: targetZ,
                    duration: 800,
                    easing: 'easeOutQuad',
                    complete: () => {
                        if (spark.parentNode) {
                            spark.parentNode.removeChild(spark);
                        }
                    }
                });
            }
        }

        function propagateWords(sourceLayerIdx, words) {
            const sourceLayer = state.neurons[sourceLayerIdx];
            const targetLayer = state.neurons[sourceLayerIdx + 1];
            
            words.forEach((word, wordIdx) => {
                setTimeout(() => {
                    const numPaths = Math.min(2, targetLayer.length);
                    
                    for (let p = 0; p < numPaths; p++) {
                        setTimeout(() => {
                            const source = sourceLayer[Math.floor(Math.random() * sourceLayer.length)];
                            const target = targetLayer[Math.floor(Math.random() * targetLayer.length)];
                            
                            createWordSignal(source.position, target.position, word, source.color);
                        }, p * 150);
                    }
                }, wordIdx * 250);
            });
        }

        function createWordSignal(start, end, word, color) {
            const container = document.getElementById('network-container');
            
            const signal = document.createElement('a-entity');
            signal.setAttribute('position', `${start.x} ${start.y} ${start.z}`);
            
            // Glowing text
            const text = document.createElement('a-text');
            text.setAttribute('value', word);
            text.setAttribute('align', 'center');
            text.setAttribute('width', '0.7');
            text.setAttribute('color', '#FFFFFF');
            text.setAttribute('shader', 'flat');
            text.setAttribute('look-at', '[camera]');
            text.setAttribute('position', '0 0 0.02');
            
            // Golden glow background
            const bgGlow = document.createElement('a-plane');
            bgGlow.setAttribute('width', '0.4');
            bgGlow.setAttribute('height', '0.15');
            bgGlow.setAttribute('color', color);
            bgGlow.setAttribute('material', `
                shader: flat;
                transparent: true;
                opacity: 0.8;
                emissive: ${color};
                emissiveIntensity: 2.5;
            `);
            bgGlow.setAttribute('look-at', '[camera]');
            
            // Outer glow ring
            const glowRing = document.createElement('a-ring');
            glowRing.setAttribute('radius-inner', '0.18');
            glowRing.setAttribute('radius-outer', '0.25');
            glowRing.setAttribute('color', '#FFFF00');
            glowRing.setAttribute('material', `
                shader: flat;
                transparent: true;
                opacity: 0.5;
                side: double;
            `);
            glowRing.setAttribute('look-at', '[camera]');
            
            // Particle trail
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    createTrailParticle(signal.object3D.position.clone());
                }, i * 150);
            }
            
            signal.appendChild(glowRing);
            signal.appendChild(bgGlow);
            signal.appendChild(text);
            container.appendChild(signal);
            
            state.activeSignals.push({ element: signal, word });
            
            anime({
                targets: signal.object3D.position,
                x: end.x,
                y: end.y,
                z: end.z,
                duration: CONFIG.signalSpeed,
                easing: 'linear',
                complete: () => {
                    const index = state.activeSignals.findIndex(s => s.element === signal);
                    if (index > -1) state.activeSignals.splice(index, 1);
                    
                    if (signal.parentNode) {
                        signal.parentNode.removeChild(signal);
                    }
                }
            });
            
            anime({
                targets: glowRing.object3D.scale,
                x: [1, 1.4, 1],
                y: [1, 1.4, 1],
                z: [1, 1.4, 1],
                duration: CONFIG.signalSpeed,
                easing: 'easeInOutSine'
            });
        }

        function createTrailParticle(position) {
            const container = document.getElementById('network-container');
            
            const particle = document.createElement('a-sphere');
            particle.setAttribute('radius', '0.025');
            particle.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
            particle.setAttribute('material', `
                shader: flat;
                color: #FFFF00;
                emissive: #FFFF00;
                emissiveIntensity: 3;
                transparent: true;
            `);
            
            container.appendChild(particle);
            
            anime({
                targets: particle.object3D,
                opacity: [1, 0],
                duration: 600,
                easing: 'easeOutQuad',
                complete: () => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }
            });
            
            anime({
                targets: particle.object3D.scale,
                x: [1, 0.1],
                y: [1, 0.1],
                z: [1, 0.1],
                duration: 600,
                easing: 'easeOutQuad'
            });
        }
    </script>
</body>
</html>
